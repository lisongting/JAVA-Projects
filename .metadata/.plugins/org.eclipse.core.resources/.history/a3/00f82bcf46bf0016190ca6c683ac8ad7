package APPServerTest;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.DataInputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.text.SimpleDateFormat;
import java.util.Date;

import org.json.JSONArray;
import org.json.JSONObject;

public class SimpleServer {
	
	public void startServer()throws Exception{
		InetAddress inetAddress =InetAddress.getLocalHost();
		ServerSocket ss = new ServerSocket(30000);
		System.out.println("getHostAddress:"+inetAddress.getHostAddress());
		while (true){
			Socket s  = ss.accept();
			System.out.println("已连接一个客户端");
			InputStream inputStream =  s.getInputStream();
			InputStreamReader inputSReader = new InputStreamReader(inputStream,"utf-8");
			BufferedReader reader = new BufferedReader(inputSReader);
			String ip = s.getInetAddress().toString();
			String tmp ;
			System.out.println("客户端ip地址是："+ip);
			DataInputStream dataInput =  new DataInputStream(s.getInputStream());
			ByteArrayOutputStream baos = new ByteArrayOutputStream();
			byte[] by = new byte[4096];
			int n;
			while((n=dataInput.read(by))!=-1){
				baos.write(by,0,n);
			}
			String strInputstream = new String(baos.toByteArray());
			System.out.println("接受到数据的数据长度是："+strInputstream.length());
			
			JSONArray jsonArray = new JSONArray(strInputstream);
			int length = jsonArray.length();
			System.out.println("jsonArray长度是："+length);
			for(int i=0;i<length;i++){
				JSONObject jsonObj = null;
				jsonObj = jsonArray.getJSONObject(i);
				String name = (String) jsonObj.get("name");
				String phone = (String)jsonObj.get("phone");
				System.out.print("姓名："+name+"  电话："+phone);
				System.out.println();
			}
//			JSONObject json = new JSONObject(strInputstream);
//			int aa =  (int)json.get("1");
//			System.out.println("1是："+aa);
			
//			while((tmp=reader.readLine())!=null){
//				System.out.println("app发来的消息："+tmp);
//				getTime();
//			}
			s.close();
		}
	}
	public static void main(String[] args){
		SimpleServer server = new SimpleServer();
		try{
			server.startServer();
		}catch(Exception e){
			e.printStackTrace();
		}
	}
	public void getTime(){
		Date date = new Date();
		SimpleDateFormat sdf  = new SimpleDateFormat("yyyy--MM--dd--HH--mm--ss");
		//String str = sdf.format(System.currentTimeMillis());
		String str = sdf.format(date);
		System.out.println("时间是："+str);
		
	}
}
